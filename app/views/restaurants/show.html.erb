<html>
<head>


<title><%= @title %></title>

<%= stylesheet_link_tag "restaurantStyle", "http://fonts.googleapis.com/css?family=Lobster+Two", 
										"http://fonts.googleapis.com/css?family=News+Room",
										"http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" %>
<%= javascript_include_tag :defaults, "http://connect.facebook.net/en_US/all.js", 																										
										"http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js",
										"http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" %>


<!--This is for displaying on iOS -->
<meta name="viewport" content="width=500">
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon-precomposed" href="../images/appleLogo.jpg" />

<!--<script type="text/javascript" src="<?php echo $this->config->system_url(); ?>assets/js/bookmark_bubble.js"></script>
<script type="text/javascript" src="<?php echo $this->config->system_url(); ?>assets/js/bubble_example.js"></script>-->

<!-- To show the google maps widget -->
<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?sensor=false">
</script>

<script type="text/javascript"> 
  function mapsInitialize() {
    var myLatlng = new google.maps.LatLng(<%= @restaurant.lat %>,<%= @restaurant.long %>);
    var myOptions = {
      zoom: 15,
      center: myLatlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    var marker = new google.maps.Marker({
        position: myLatlng, 
        map: map,
        title: "<%= @restaurant.name.squeeze(" ").tr("(),?!':.[]", "") %>"
    });   

  }

</script>

<!--Facebook Meta Tags -->
<meta property="og:title" content="<%= @restaurant.name.squeeze(" ").tr("(),?!':.[]", "") %> - foodierecs" />
<meta property="og:type" content="restaurant" />
<meta property="og:url" content="<%= "http://foodierecs.heroku.com"+request.fullpath %>" />
<meta property="og:image" content="" />
<meta property="og:site_name" content="foodierecs.com" />
<meta property="fb:app_id" content="213050112074083" />

<script>
//so we can make delete requests
function _ajax_request(url, data, callback, type, method) {
    if (jQuery.isFunction(data)) {
        callback = data;
        data = {};
    }
    return jQuery.ajax({
        type: method,
        url: url,
        data: data,
        success: callback,
        dataType: type
        });
}

jQuery.extend({
    put: function(url, data, callback, type) {
        return _ajax_request(url, data, callback, type, 'PUT');
    },
    delete_: function(url, data, callback, type) {
        return _ajax_request(url, data, callback, type, 'DELETE');
    }
});
</script>


<% if session[ :background_pic ].nil? 
	backgroundPic = rand( 6 ) + 1 
	session[ :background_pic ] = backgroundPic
end %>

</head>
<body onload="setTimeout(function() { window.scrollTo(0, 1) }, 500); $('#dialog').dialog({ autoOpen:false, modal:true }); mapsInitialize();
				$('html').css( 'background', 
					'url(../images/background<%=session[ :background_pic ]%>.jpg) no-repeat center center fixed' );" >
<div id="fb-root"></div>
	<!--facebook connect-->
	<script>
	  window.fbAsyncInit = function() {
    	FB.init({appId: '213050112074083', status: true, cookie: true,
	             xfbml: true});
	  };
	  (function() {
	    var e = document.createElement('script'); e.async = true;
    	e.src = document.location.protocol +
	      '//connect.facebook.net/en_US/all.js';
    	document.getElementById('fb-root').appendChild(e);
	  }());
	</script>

	<!--
	<div class="backgroundImageWrap">
		<img src="../images/bar.jpg" class="backgroundImage" width="1264" height="790">
	</div>
	-->
	<div id="restaurantContent">
		<div id="header">
			foodierecs
		</div>
		
		<div id="restaurantInfo">
			<div id="restaurantName">
				<%= @restaurant.name %>
			</div>
			
			<div id="restaurantAddress">
				<%= @restaurant.address %>
			</div>
		</div>
		
		<div class="restaurantRecommend">
			<fb:like href="<%="http://foodierecs.heroku.com"+request.fullpath%>" send="false" layout="button_count" width="50" show_faces="true" font="verdana" style="float:left"></fb:like>
			<% if ( !current_user.nil? && !Opinion.where( :user_id => current_user.id, :restaurant_id => @restaurant.id ).exists? ) %>
				<a href=""><img id="notForFoodies" src="../images/not-for-foodies.jpg" /></a>
			<% end %>
		</div>
		
		<%if( !current_user.nil? )%>
		<script>
		$('#notForFoodies').click(function(){
			$.post( "/opinions", { 'opinion[user_id]': <%=current_user.id%>, 'opinion[restaurant_id]': <%=@restaurant.id%>,
				 					'opinion[foodie]': <%=current_user.foodie%>, 'opinion[like]': -1 },
				function( data ){
					alert( 'Marked as not for foodies!' );
				})
		});
		</script>
		
		
		<div id="dialog" title="Recommendations" style="display:none" >
			<% @opinion = Opinion.new %>
			<%= render :partial => 'opinions/form' %>
		</div>
		<%end%>
	
		<script>
			FB.Event.subscribe('edge.create', function(response) {
				//basically, we pretend like the user doesn't want to add a to eat/to drink and add the row
				//then, if they do add it, this row will get deleted and replaced by the new one. nice!
				//alternatively, if they aren't signed in, we'll send them to authorization
				<% if !session[ :user ].nil? %>
				$.post( "<%= url_for( :controller => 'opinions', :only_path => false ) %>", 
						{ 'opinion[user_id]': <%= current_user.id %>, 'opinion[restaurant_id]': <%= @restaurant.id %>,
							'opinion[foodie]': <%= current_user.foodie %>, 'opinion[like]': 1 } );
				<% else %>
				 	window.location = "/"
				<% end %>
				//need to do this next line because the form doesn't know what opinion
				$('#opinion_restaurant_id').attr( 'value', <%=@restaurant.id%> );
				$("#dialog").dialog('open');
  			});
			<% #puts "\n\n session user id is " + session[ :user ].id.to_s + "\n\n\n" %>
			<% if !session[ :user ].nil? && Opinion.where( :user_id => session[ :user ].id, :restaurant_id => @restaurant.id ).exists? %>
			FB.Event.subscribe('edge.remove', function(response) {
				jQuery.ajax({
				  url: '/opinions/<%=Opinion.where( :user_id => current_user.id, :restaurant_id => @restaurant.id ).first.id %>',
				  type: "DELETE",
				  data: {
				    markdown: 'true'
				  },
				  success: function(data) {
				    alert("Done!")
				  },
				  error: function(data, statusCode) {
				    alert("ERROR")
				  }
				});
  			});
			<% end %>
		</script>
		
		<div class="foodieList">
			<b><%= "Foodies who like " + @restaurant.name %>:</b> <br/>
			<% @foodie = true %>
			<% unless @restaurant.opinions.empty? %>
				<table class="opinions" summary="User opinions">
					<%= render @opinions %>
				</table>
				<%= will_paginate @opinions %>
			<% end %>
		</div>
		
		<div class="likeFacePile">
			<b><%= "Everyone who likes " + @restaurant.name %>:</b> <br />
			<div id="fb-root"></div><script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script><fb:facepile href="<%= request.url; %>" width="200" max_rows="5"></fb:facepile>
		</div>
		
		<div id="map_canvas"></div>
		
		<div class="commentsWrapper">
		<div class="restaurantComments">
			<div id="fb-root"></div>
			<script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script>
			<!--Replace the URL for this page and width here-->
			<div id="fb-root"></div><script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script><fb:comments href="<%= request.url; %>" num_posts="5" width="500"></fb:comments>
		</div>
		</div>
		
	</div>

</body>
</html>